<!DOCTYPE html>
<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-38176147-3"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-38176147-3');
  </script>

  <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
  <title>Generate t-SNE</title>
  <link rel="shortcut icon" href="static/favicon.ico">
  <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"> -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
  <!-- <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script> -->
  <link href="static/css/bootstrap.min.css" rel="stylesheet">
  <link href="static/node_modules/bootstrap-colorpicker/dist/css/bootstrap-colorpicker.css" rel="stylesheet">
  <link rel="stylesheet" href="./static/css/app.css">

  <script>
    $(function () {
      $('[data-toggle="tooltip"]').tooltip()
    })

    $(function () {
     $('#cp').colorpicker();
   });
    $(document).ready(function() { 
        document.getElementById("fileinput").style.border = "2px dashed #2e7591";
        document.getElementById("instruction_step1").style.border = "2px dashed #2e7591";
      $(document).one('mousemove', function() {  
        document.getElementById("fileinput").style.border = "0px";
        document.getElementById("instruction_step1").style.border = "0px";
      });
    });


  function setVisible_step1(){
    document.getElementById("fileinput").style.border = "2px dashed #2e7591";
    document.getElementById("step2").style.border = "0px";
    document.getElementById("step3").style.border = "0px";
    document.getElementById("step4").style.border = "0px";
    document.getElementById("generate_button").style.border = "0px";

    document.getElementById("instruction_step1").style.border = "2px dashed #2e7591";
    document.getElementById("instruction_step2").style.border = "0px";
    document.getElementById("instruction_step3").style.border = "0px";
    document.getElementById("instruction_step4").style.border = "0px";
    document.getElementById("instruction_step5").style.border = "0px";
  }
  function setVisible_step2(){
    document.getElementById("fileinput").style.border = "0px";
    document.getElementById("step2").style.border = "2px dashed #2e7591";
    document.getElementById("step3").style.border = "0px";
    document.getElementById("step4").style.border = "0px";
    document.getElementById("generate_button").style.border = "0px";

    document.getElementById("instruction_step1").style.border = "0px";
    document.getElementById("instruction_step2").style.border = "2px dashed #2e7591";
    document.getElementById("instruction_step3").style.border = "0px";
    document.getElementById("instruction_step4").style.border = "0px";
    document.getElementById("instruction_step5").style.border = "0px";
  }
  function setVisible_step3(){
    document.getElementById("fileinput").style.border = "0px";
    document.getElementById("step2").style.border = "0px";
    document.getElementById("step3").style.border = "2px dashed black";
    document.getElementById("step4").style.border = "0px";
    document.getElementById("generate_button").style.border = "0px";

    document.getElementById("instruction_step1").style.border = "0px";
    document.getElementById("instruction_step2").style.border = "0px";
    document.getElementById("instruction_step3").style.border = "2px dashed #2e7591";
    document.getElementById("instruction_step4").style.border = "0px";
    document.getElementById("instruction_step5").style.border = "0px";
  }
  function setVisible_step4(){
    document.getElementById("fileinput").style.border = "0px";
    document.getElementById("step2").style.border = "0px";
    document.getElementById("step3").style.border = "0px";
    document.getElementById("step4").style.border = "2px dashed #2e7591";
    document.getElementById("generate_button").style.border = "0px";

    document.getElementById("instruction_step1").style.border = "0px";
    document.getElementById("instruction_step2").style.border = "0px";
    document.getElementById("instruction_step3").style.border = "0px";
    document.getElementById("instruction_step4").style.border = "2px dashed #2e7591";
    document.getElementById("instruction_step5").style.border = "0px";
  }
  function setVisible_step5(){
    document.getElementById("fileinput").style.border = "0px";
    document.getElementById("step2").style.border = "0px";
    document.getElementById("step3").style.border = "0px";
    document.getElementById("step4").style.border = "0px";
    document.getElementById("generate_button").style.border = "2px dashed #2e7591";

    document.getElementById("instruction_step1").style.border = "0px";
    document.getElementById("instruction_step2").style.border = "0px";
    document.getElementById("instruction_step3").style.border = "0px";
    document.getElementById("instruction_step4").style.border = "0px";
    document.getElementById("instruction_step5").style.border = "2px dashed #2e7591";
  }


    function generateTSNE() {
    // do ajax request to ask for what the location of the TSNE image is. Then use in in the following line.
    console.log('button pressed')
    httpGetAsync('/test',handleTSNEResponse)
  }
  function httpGetAsync(theUrl, callback)
  {
    console.log('async 1')
    var xmlHttp = new XMLHttpRequest();
    xmlHttp.onreadystatechange = function() { 
      if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
        callback(xmlHttp.responseText);
    }
    xmlHttp.open("GET", theUrl, true); // true for asynchronous 
    xmlHttp.send(null);
    console.log('async 2')
  }
  function handleTSNEResponse(responseText) {
    console.log('async callback')
    console.log(responseText)
    document.getElementById("tsne_plot").src = responseText
    console.log('done')
  }
  function deleteArrow1(){
    document.getElementById("arrow1").remove();
  }
  function setVisible() {
    document.getElementById("instruction").remove();
    document.getElementById("arrow2").remove();
    // set image data visible 
    document.getElementById("loader").style.visibility = "visible";
  }
  function checkFolder() {
    console.log('hi')

    alert("hi");
      // if(document.getElementById("image").files.length == 0 ){
        if(document.getElementById("input-images")=== null ){

          console.log("no files selected");
          alert("no files selected");
        }
      }
      function sanityCheckInputFiles() {
    // Get files that user selected
    input = document.getElementById('fileinput');
    files = input.files;


    // console.log('input.files[0]: ', input.files[0], files[0].size);
    for (i = 0; i < files.length; i++) { 
      if (files[i].size>3*1024*1024) { // this is 3 MiB
        $('#modalImageTooBig').modal('show');
      }
    }

    
    // Check if number of files exceed limit
    num_image_limit = 100;
    existing_images = document.getElementsByClassName('input-image');
    num_existing_images = existing_images.length;
    if (num_existing_images + files.length > num_image_limit){
      input.value = '';
      $('#modalTooManyImages').modal('show');
    }

    // Check if size of files exceed limit

  }

</script>

</head>



<body>

  <!-- Modal for exceeding maximum number of images-->
  <div class="modal fade" id="modalTooManyImages" tabindex="-1" role="dialog" aria-labelledby="modalTooManyImagesLabel">
    <div class="modal-dialog" role="document" style="color:#333">
      <div class="modal-content">
        <div class="modal-header alert alert-danger">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
          <h4 class="modal-title" id="modalTooManyImagesLabel">Too Many Image Files</h4>
        </div>
        <div class="modal-body">
          <p>Sorry, you have exeeded the maximum number of images that can be uploaded which is 100. The images that you have selected have been ignored.</p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-default" data-dismiss="modal">Ok</button>
        </div>
      </div>


    </div>
  </div>

  <!-- Modal for exceeding max image size -->
  <div class="modal fade" id="modalImageTooBig" tabindex="-1" role="dialog" aria-labelledby="modalImageTooBigLabel">
    <div class="modal-dialog" role="document" style="color:#333">
      <div class="modal-content">
        <div class="modal-header alert alert-danger">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
          <h4 class="modal-title" id="modalImageTooBigLabel">Image size too big</h4>
        </div>
        <div class="modal-body">
          <p>Sorry, you have exeeded the maximum size of images that can be uploaded which is 3MB. The images that you have selected have been ignored.</p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-default" data-dismiss="modal">Ok</button>
        </div>
      </div>

    </div>
  </div>


  <!-- Header -->
  <div class="row" > 
    <div class="header col-md-12" >
      <span class="header-text">
        Generate t-SNE Plots in the Browser
      </span>
      <span>
        <img src="static/images/dots.png" style="height:39px" class="header-img">
      </span>
    </div>
  </div>

  <!-- Body -->
  <div class = "container">
  <div class="row equal">

    <!-- left side of the layout -->
    <div class = "col-md-6 leftside" style="padding-left: 45px">
<!--       {% if not image_exists %}
        <img class = "arrow1-position" id="arrow1" src="static/images/picture4.png"> 
      {% else %}
        <img class = "arrow2-position" id="arrow2" src="static/images/picture4.png"> 
      {% endif %}
 -->      <!-- upload images -->
      <h1>Upload New Images</h1>
      <form method=post enctype=multipart/form-data>
        Select images: (max. 100 images, max. 3 MB each)
        <input id="fileinput" onchange="sanityCheckInputFiles()" type=file name=file accept="image/*" multiple style="    opacity: 0.7;">
        <div id="cp" class="input-group colorpicker-component col-sm-4" title="Using input value">
          <input id= "step2" name="hexcolor" type="text" class="form-control input-lg " value="#196f90" style="height: 34px;font-size: 16px;" />
          <span class="input-group-addon" "><i></i></span>
        </div>

        <input id="step3" type="submit"  class="btn btn-primary" type=submit value=Upload onclick= "deleteArrow1()" style="opacity: 0.7; border-width: 0px;">
      </form>

      {% for color in colors %}
      <div style="margin:4px 0px">
        {% for image in color.images %}
        <span id="input-images">
          <img class="input-image zoomed" src="{{ image }}" style= "object-fit:cover; border:5px solid #{{ color.hex }}" height="42" width="42"/>

        </span>
        {% endfor %}
      </div>
      {% endfor %}

      <!-- parameters -->
      <form id="step4"  class="form-horizontal" action = '/tsne' >
        <h3 style="padding-top: 15px; border-top: 1px solid rgba(18, 65, 69, .07);" >Resizing Parameters </h3> 
        <span id="helpBlock" class="help-block">Values for the dimension of each image.</span>
        <div class="form-group">
          <label for="inputEmail3" class="col-sm-3 control-label">Resolution</label>
          <img src="static/images/tooltip.png" style="width:50px;height:38px;" class="btn btn-secondary invert" data-toggle="tooltip" data-placement="right" title="The resolution of each image.">
          <div class="col-sm-4">
            <input type="number" class="form-control" name = "resolution" id="number" value = "200" placeholder="resolution">
          </div>
        </div>
        <!-- tSNE Parameters form -->
        <h3 style="padding-top: 15px; border-top: 1px solid rgba(18, 65, 69, .07);">t-SNE Parameters</h3> 
        <span id="helpBlock" class="help-block">Different values result in different result</span>
        <div class="form-group">
          <label for="inputEmail3" class="col-sm-3 control-label">Perplexity</label>
          <img src="static/images/tooltip.png" style="width:50px;height:38px;" class="btn btn-secondary invert" data-toggle="tooltip" data-placement="right" title="The perplexity is related to the number of nearest neighbors that is used in other manifold learning algorithms. Larger datasets usually require a larger perplexity. Consider selecting a value between 5 and 50. The choice is not extremely critical since t-SNE is quite insensitive to this parameter.">
          <div class="col-sm-4">
            <input type="number" class="form-control"  name = "perplexity" id="number" value = "15" placeholder="perplexity">
          </div>
        </div>
        <div class="form-group">
          <label for="inputEmail3" class="col-sm-3 control-label">Early Exaggeration</label>
          <img src="static/images/tooltip.png" style="width:50px;height:38px;" class="btn btn-secondary invert" data-toggle="tooltip" data-placement="right" title="Controls how tight natural clusters in the original space are in the embedded space and how much space will be between them. For larger values, the space between natural clusters will be larger in the embedded space. Again, the choice of this parameter is not very critical. If the cost function increases during initial optimization, the early exaggeration factor or the learning rate might be too high.">
          <div class="col-sm-4">
            <input type="number" class="form-control"  name = "early_exaggeration" id="number" value = "12" placeholder="early_exaggeration">
          </div>
        </div>
        <div class="form-group">
          <label for="inputEmail3" class="col-sm-3 control-label">Learning Rate</label>
          <img src="static/images/tooltip.png" style="width:50px;height:38px;" class="btn btn-secondary invert" data-toggle="tooltip" data-placement="right" title="The learning rate for t-SNE is usually in the range [10.0, 1000.0]. If the learning rate is too high, the data may look like a ‘ball’ with any point approximately equidistant from its nearest neighbours. If the learning rate is too low, most points may look compressed in a dense cloud with few outliers. If the cost function gets stuck in a bad local minimum increasing the learning rate may help.">
          <div class="col-sm-4">
            <input type="number" class="form-control"  name = "learning_rate" id="number" value = "200" placeholder="learning_rate">
          </div>
        </div>
        <h3 style="padding-top: 15px; border-top: 1px solid rgba(18, 65, 69, .07);">Output Plot Parameters</h3> 
        <span id="helpBlock" class="help-block">The resolution of the image</span>
        <div class="form-group">
          <label for="inputEmail3" class="col-sm-3 control-label">Dots Per Inchs</label>
          <img src="static/images/tooltip.png" style="width:50px;height:38px;" class="btn btn-secondary invert" data-toggle="tooltip" data-placement="right" title="The resolution of the final plot. The bigger the value, the better the image quality. However, the plot generating speed increases as the resolution gets higher.">
          <div class="col-sm-4">
            <input type="number" class="form-control" name = "DotsPerInchs" id="number" value = "300" placeholder="DotsPerInchs">
          </div>
        </div>
        <div class="form-group">
          <label for="inputEmail3" class="col-sm-3 control-label">Canvas Size</label>
          <img src="static/images/tooltip.png" style="width:50px;height:38px;" class="btn btn-secondary invert" data-toggle="tooltip" data-placement="right" title="Size of the plot">
          <div class="col-sm-4">
            <input type="number" class="form-control"  name = "CanvasSize" id="number" value = "4000" placeholder="canvas size">
          </div>
        </div>
        <!-- set the loading icon visible when the "generate" tSNE button is pressed  -->
        <input type="hidden" name="session" value="{{session_id}}">
        <input type="hidden" name="colors" value="{{colors}}">
        <div class="form-group">
          <div class="col-sm-offset-4 col-sm-3" >
          {% if not image_exists %}
            <button type="submit" class="btn btn-success" id= "generate_button" style="opacity: 0.7; border-width: 0px; z-index: 100;" onclick= "setVisible()" onclick= "checkFolder()" onclick="generateTSNE()" disabled>Generate t-SNE</button>
          {% else %}
            <button type="submit" class="btn btn-success" id= "generate_button" style="opacity: 0.7; border-width: 0px; z-index: 100;" onclick= "setVisible()" onclick= "checkFolder()" onclick="generateTSNE() ">Generate t-SNE</button>
          {% endif %}
          </div>
        </div>
      </form>
    </div>


    <div class = "col-md-6 rightside">
      <svg class="svg-container" >
        <!-- the flower loading icon -->
        <symbol id="ei-spinner-icon" viewBox="0 0 50 50"><path d="M25 18c-.6 0-1-.4-1-1V9c0-.6.4-1 1-1s1 .4 1 1v8c0 .6-.4 1-1 1z"></path><path opacity=".3" d="M25 42c-.6 0-1-.4-1-1v-8c0-.6.4-1 1-1s1 .4 1 1v8c0 .6-.4 1-1 1z"></path><path opacity=".3" d="M29 19c-.2 0-.3 0-.5-.1-.4-.3-.6-.8-.3-1.3l4-6.9c.3-.4.8-.6 1.3-.3.4.3.6.8.3 1.3l-4 6.9c-.2.2-.5.4-.8.4z"></path><path opacity=".3" d="M17 39.8c-.2 0-.3 0-.5-.1-.4-.3-.6-.8-.3-1.3l4-6.9c.3-.4.8-.6 1.3-.3.4.3.6.8.3 1.3l-4 6.9c-.2.2-.5.4-.8.4z"></path><path opacity=".93" d="M21 19c-.3 0-.6-.2-.8-.5l-4-6.9c-.3-.4-.1-1 .3-1.3.4-.3 1-.1 1.3.3l4 6.9c.3.4.1 1-.3 1.3-.2.2-.3.2-.5.2z"></path><path opacity=".3" d="M33 39.8c-.3 0-.6-.2-.8-.5l-4-6.9c-.3-.4-.1-1 .3-1.3.4-.3 1-.1 1.3.3l4 6.9c.3.4.1 1-.3 1.3-.2.1-.3.2-.5.2z"></path><path opacity=".65" d="M17 26H9c-.6 0-1-.4-1-1s.4-1 1-1h8c.6 0 1 .4 1 1s-.4 1-1 1z"></path><path opacity=".3" d="M41 26h-8c-.6 0-1-.4-1-1s.4-1 1-1h8c.6 0 1 .4 1 1s-.4 1-1 1z"></path><path opacity=".86" d="M18.1 21.9c-.2 0-.3 0-.5-.1l-6.9-4c-.4-.3-.6-.8-.3-1.3.3-.4.8-.6 1.3-.3l6.9 4c.4.3.6.8.3 1.3-.2.3-.5.4-.8.4z"></path><path opacity=".3" d="M38.9 33.9c-.2 0-.3 0-.5-.1l-6.9-4c-.4-.3-.6-.8-.3-1.3.3-.4.8-.6 1.3-.3l6.9 4c.4.3.6.8.3 1.3-.2.3-.5.4-.8.4z"></path><path opacity=".44" d="M11.1 33.9c-.3 0-.6-.2-.8-.5-.3-.4-.1-1 .3-1.3l6.9-4c.4-.3 1-.1 1.3.3.3.4.1 1-.3 1.3l-6.9 4c-.1.2-.3.2-.5.2z"></path><path opacity=".3" d="M31.9 21.9c-.3 0-.6-.2-.8-.5-.3-.4-.1-1 .3-1.3l6.9-4c.4-.3 1-.1 1.3.3.3.4.1 1-.3 1.3l-6.9 4c-.2.2-.3.2-.5.2z"></path></symbol>
        <symbol id="flower-icon" viewBox="0 0 65 98" fill="none" fill-rule="evenodd" stroke="#fff" stroke-width="2"><path d="M0.0434880207,0.660889225 C0.0434880207,0.660889225 38.4349751,22.2085462 38.4349744,96.8228805" id="Path-142"></path><path d="M62.0915607,5.40798425 C62.0915607,5.40798425 36.9588366,-4.08164371 28.3460397,24.8902199 C57.7428081,31.9172508 62.0915607,5.40798425 62.0915607,5.40798425 Z" id="Imported-Layers"></path></symbol>
      </svg>


      <section >
        <section>

          <!-- Plot displaying -->
          {% if plot_exists %}
          <script>document.getElementById("arrow2").remove();</script>
          <div class="image">
            <h1>Resulting t-SNE plot</h1>
            <img id="tsne_plot" src="static/output/{{session_id}}/output.png?timestamp={{timestamp}}" style="width: 100%; max-height: 1000px; object-fit: contain; border: 4px solid gainsboro"> 
          </div>
          <!-- download image button -->
          <a href="static/output/{{session_id}}/output.png" class="btn btn-warning text-center" id="btn-download" download="output.png" style="opacity: 0.7; border-width: 0px; display:inherit; margin: 15px">Save Image</a>
          <!-- <button type="submit" id="btn-download" class="btn btn-success" style="opacity: 0.7; border-width: 0px;>Generate t-SNE</button> -->


          {% else %}
          
          <div class="col-md-12 rightside" id = "instruction" style="visibility: visible;">
            <div class="">
              <h1> Instructions</h1> <br>
              <h4> Mouse over the instructions!</h4>
              <button id="instruction_step1" class="instruction_steps" onmouseover="setVisible_step1()">Step 1: Select the input images that you wish to run the algorithm with</button>
              <button id="instruction_step2" class="instruction_steps" onmouseover="setVisible_step2()">Step 2: Add a marker to image sets by selecting the colour of the image border</button>
              <button id="instruction_step3" class="instruction_steps" onmouseover="setVisible_step3()">Step 3: Upload the file</button>
              <button id="instruction_step4" class="instruction_steps" onmouseover="setVisible_step4()">Step 4: Select the display parameters and algorithm parameters</button>
              <button id="instruction_step5" class="instruction_steps" onmouseover="setVisible_step5()">Step 5: Generate t-SNE plot and save the generated image!</button>
            </div>
          </div>

          <div class="page-loader-content" id = "loader" style= "visibility: hidden">
            <div class="icon-loader">
              <svg class="svg-icon-loader"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#ei-spinner-icon"></use></svg>
            </div>
            <div class="icon-flower">
              <svg class="svg-icon-flower"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#flower-icon"></use></svg>
            </div>
          </div>
          {% endif %}
        </section>
      </section>

    </div>
  </div>
  </div>
    <!-- Footer -->
    <div class="row" > 
     <div class="footer col-md-12" style="background-color:#def4f6;"><br>
      <div>
      <h4 style="position: absolute; left: 120px;">Contact: hello@tsne.com</h4>
      </div>
      <a href="https://github.com/bessaFan/generate_tsne_plots_online"> <img style="opacity: 0.7;width:50px;height:50px;border:0; position:absolute; right:120px;" src="/static/images/github_icon.svg" alt="git hub link"></a><br><br>
      <div class="text-center footer-content">
        Made with ❤ in Toronto
      </div>
    </div>
  </div>

</body>


<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="static/js/bootstrap.min.js"></script>
<script src="static/node_modules/bootstrap-colorpicker/dist/js/bootstrap-colorpicker.min.js" rel="stylesheet"></script>
